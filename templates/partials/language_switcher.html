{# 语言显示名称宏 #}
{% macro get_language_name(lang_code) %}
  {% if lang_code == 'en' or lang_code == 'en-us' %}
    English
  {% elif lang_code == 'ja' or lang_code == 'ja-jp' %}
    日本語
  {% elif lang_code == 'zh' or lang_code == 'zh-cn' %}
    中文
  {% else %}
    {{ lang_code | upper }}
  {% endif %}
{% endmacro %}

<div class="lang-dropdown-wrapper">
{% if content.translated_content %}
  {% set current_language = content.language | default(content.slug | split('/') | first) %}
  {% set all_languages = [] %}

  {# 添加当前页面语言 #}
  {% do all_languages.append({
    "language": current_language,
    "slug": content.slug,
    "url": content.absolute_url|regex_replace("\\?.*$", ""),
    "is_current": true
  }) %}

  {# 添加其他语言变体 #}
  {% for lang, page in content.translated_content.items() %}
    {% do all_languages.append({
      "language": lang,
      "slug": page.slug,
      "url": page.absolute_url|regex_replace("\\?.*$", ""),
      "is_current": false
    }) %}
  {% endfor %}

<div class="lang-dropdown header-language-select">
  <button class="lang-trigger" type="button" aria-expanded="false" aria-haspopup="true">
    <span class="globe-icon">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M9.99 0C4.47 0 0 4.48 0 10C0 15.52 4.47 20 9.99 20C15.52 20 20 15.52 20 10C20 4.48 15.52 0 9.99 0ZM16.92 6H13.97C13.65 4.75 13.19 3.55 12.59 2.44C14.43 3.07 15.96 4.35 16.92 6ZM10 2.04C10.83 3.24 11.48 4.57 11.91 6H8.09C8.52 4.57 9.17 3.24 10 2.04ZM2.26 12C2.1 11.36 2 10.69 2 10C2 9.31 2.1 8.64 2.26 8H5.64C5.56 8.66 5.5 9.32 5.5 10C5.5 10.68 5.56 11.34 5.64 12H2.26ZM3.08 14H6.03C6.35 15.25 6.81 16.45 7.41 17.56C5.57 16.93 4.04 15.66 3.08 14ZM6.03 6H3.08C4.04 4.34 5.57 3.07 7.41 2.44C6.81 3.55 6.35 4.75 6.03 6ZM10 17.96C9.17 16.76 8.52 15.43 8.09 14H11.91C11.48 15.43 10.83 16.76 10 17.96ZM12.34 12H7.66C7.57 11.34 7.5 10.68 7.5 10C7.5 9.32 7.57 8.65 7.66 8H12.34C12.43 8.65 12.5 9.32 12.5 10C12.5 10.68 12.43 11.34 12.34 12ZM12.59 17.56C13.19 16.45 13.65 15.25 13.97 14H16.92C15.96 15.65 14.43 16.93 12.59 17.56ZM14.36 12C14.44 11.34 14.5 10.68 14.5 10C14.5 9.32 14.44 8.66 14.36 8H17.74C17.9 8.64 18 9.31 18 10C18 10.69 17.9 11.36 17.74 12H14.36Z" fill="currentColor"/>
      </svg>
    </span>
    <span class="current-lang">
      {{ get_language_name(current_language) }}
    </span>
    <span class="arrow">
      <svg width="6" height="4" viewBox="0 0 6 4" fill="none" xmlns="http://www.w3.org/2000/svg">
        <line x1="0.353553" y1="0.353539" x2="3.35355" y2="3.35354" stroke="currentColor"/>
        <line y1="-0.5" x2="4.24264" y2="-0.5" transform="matrix(-0.707107 0.707107 0.707107 0.707107 6 0.707092)" stroke="currentColor"/>
      </svg>
    </span>
  </button>

  <div class="lang-menu" role="menu">
    <div class="lang-menu-header">LANGUAGE</div>
    <div class="lang-menu-items">
      {% for item in all_languages %}
        {% if item.is_current %}
          <span
            class="lang-item active disabled"
            data-lang="{{ item.language }}"
            role="menuitem"
            data-url="{{ item.url }}"
            aria-current="true"
          >
            {{ get_language_name(item.language) }}
          </span>
        {% else %}
          <a
            href="#"
            data-url="{{ item.url }}"
            class="lang-item"
            data-lang="{{ item.language }}"
            role="menuitem"
            onclick="window.location.href=this.dataset.url; return false;"
          >
            {{ get_language_name(item.language) }}
          </a>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}
</div>

<script>
(function() {
  'use strict';
  
  document.addEventListener('DOMContentLoaded', function () {
    const langDropdowns = document.querySelectorAll('.lang-dropdown');
    
    langDropdowns.forEach(function(dropdown) {
      const trigger = dropdown.querySelector('.lang-trigger');
      const menu = dropdown.querySelector('.lang-menu');
      const items = dropdown.querySelectorAll('.lang-item');
      let isOpen = false;
      let isMobileMode = false;
      
      function isMobile() {
        return window.innerWidth <= 767;
      }
      
      function toggleMenu(e) {
        e.preventDefault();
        e.stopPropagation();
        isOpen = !isOpen;
        dropdown.classList.toggle('active', isOpen);
        trigger.setAttribute('aria-expanded', isOpen);
      }
      
      function closeMenu() {
        if (isOpen) {
          isOpen = false;
          dropdown.classList.remove('active');
          trigger.setAttribute('aria-expanded', 'false');
        }
      }
      
      function handleOutsideClick(e) {
        if (!dropdown.contains(e.target)) {
          closeMenu();
        }
      }
      
      function initMobileEvents() {
        if (!isMobileMode) {
          isMobileMode = true;
          trigger.addEventListener('click', toggleMenu);
          document.addEventListener('click', handleOutsideClick);
        }
      }
      
      function removeMobileEvents() {
        if (isMobileMode) {
          isMobileMode = false;
          closeMenu();
          trigger.removeEventListener('click', toggleMenu);
          document.removeEventListener('click', handleOutsideClick);
        }
      }
      
      function handleResize() {
        if (isMobile()) {
          initMobileEvents();
        } else {
          removeMobileEvents();
        }
      }
      
      handleResize();
      window.addEventListener('resize', handleResize);
      
      items.forEach(function(item) {
        if (item.classList.contains('disabled')) {
          return;
        }
        
        item.addEventListener('click', function () {
          const lang = this.dataset.lang;
          if (lang) {
            document.cookie = 'preferred_language=' + lang + '; path=/; max-age=' + (60 * 60 * 24 * 365);
          }
        });
      });
    });
  });
})();
</script>
